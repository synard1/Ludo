"use strict";var KTTicket=function(){var t,e,a,r,o,i,n,s,c,d,l,u,m,p,f,k,g,b=function(){a=["reload","print",{extend:"colvis"}],$.fn.dataTable.ext.buttons.reload={text:"Reload",action:function(t,e,a,r){e.ajax.reload()}},canCreateTicket&&a.push({text:"New Ticket",action:function(t,e,a,r){$("#kt_docs_card_ticket_list").collapse("hide"),$("#kt_docs_card_ticket_new").collapse("show")}}),t=$("#ticketTable").DataTable({ajax:{url:"/apps/helpdesk/api/ticket"},columns:[{targets:0,data:null,render:function(t,e,a,r){return r.row+1}},{data:"subject"},{data:"user_name"},{data:"description"},{data:"origin_unit"},{data:"source_report"},{data:"priority"},{data:"issue_category",render:function(t,e,a){return Array.isArray(t)?t.join(", "):t}},{targets:10,data:"status",render:function(t,e,a){var r='<a href="#" class="status-change" data-bs-toggle="modal" data-bs-target="#kt_modal_change_status" data-id="'+a.id+'" data-status="'+a.status+'"><i class="ki-duotone ki-pencil fs-5"><span class="path1"></span><span class="path2"></span></i></a> <a href="#" class="status-history" data-bs-toggle="modal" data-bs-target="#kt_modal_history_status" data-id="'+a.id+'"><i class="ki-duotone ki-time fs-5"><span class="path1"></span><span class="path2"></span></i></a>',o=function(t){var e="";switch(t.toLowerCase()){case"open":e="success";break;case"pending":e="warning";break;case"closed":e="secondary";break;case"resolved":e="primary";break;case"in progress":e="info";break;default:return t}return'<span class="badge badge-'+e+'">'+t.charAt(0).toUpperCase()+t.slice(1)+"</span>"}(t);return isSupervisor?o+" "+r:o}},{targets:12,data:"work_order",render:function(t,e,a){return t?'<span class="badge badge-primary"><a href="/apps/helpdesk/print/wo/'+a.work_order+'" target="_blank" class="text-info view-work-order" data-id="'+a.id+'">View</a></span>':isSupervisor?'<a href="#" data-bs-toggle="modal" data-bs-target="#kt_modal_work_order" class="generate-work-order"  data-id="'+a.id+'" data-report-time="'+a.report_time+'">Generate Work Order</a>':'<a href="#">N/A</a>'}},{class:"text-end",orderable:!1,data:"actionButtons"}],dom:"Bfrtip",columnDefs:[{targets:3,visible:!1}],buttons:a}),t.$,t.buttons().container().appendTo($(".dataTables_wrapper .col-md-6:eq(0)")),t.on("draw",(function(){_(),KTMenu.init()})),$("#ticketTable").on("click",".status-history",(function(){!function(t){a=["reload","print"],$.fn.dataTable.ext.buttons.reload={text:"Reload",action:function(t,e,a,r){e.ajax.reload()}},e=$("#historyTable").DataTable({ajax:{url:"/apps/helpdesk/api/ticket/statushistory",data:{ticket_id:t}},columns:[{targets:0,data:null,render:function(t,e,a,r){return r.row+1}},{data:"status"},{data:"reason"},{data:"created_by"},{data:"created_at",title:"Created Date",render:function(t,e,a){return"display"===e||"filter"===e?t.toLocaleString():t}}],dom:"Bfrtip",buttons:a}),e.$,e.buttons().container().appendTo($(".dataTables_wrapper .col-md-6:eq(0)")),e.on("draw",(function(){KTMenu.init()}))}($(this).data("id"))}))},_=()=>{document.querySelectorAll('[data-kt-docs-table-filter="delete_row"]').forEach((e=>{e.addEventListener("click",(function(e){e.preventDefault();const a=e.target.closest("tr").querySelectorAll("td")[1].innerText,r=$(this).data("id");console.log(r),Swal.fire({text:"Are you sure you want to delete "+a+"?",icon:"warning",showCancelButton:!0,buttonsStyling:!1,confirmButtonText:"Yes, delete!",cancelButtonText:"No, cancel",customClass:{confirmButton:"btn fw-bold btn-danger",cancelButton:"btn fw-bold btn-active-light-primary"}}).then((function(e){e.value?Swal.fire({text:"Deleting "+a,icon:"info",buttonsStyling:!1,showConfirmButton:!1,timer:2e3}).then((function(){$.ajax({url:"/apps/helpdesk/api/deleteTicket/"+r,type:"DELETE",success:function(e){swal.fire({text:e.message,icon:"success",buttonsStyling:!1,confirmButtonText:"Ok, got it!",customClass:{confirmButton:"btn font-weight-bold btn-light-primary"}}).then((function(){t.draw()}))},error:function(t){let e="Sorry, looks like there are some errors detected, please try again.";t.responseJSON&&t.responseJSON.message&&(e=t.responseJSON.message),Swal.fire({text:e,icon:"error",buttonsStyling:!1,confirmButtonText:"Ok, got it!",customClass:{confirmButton:"btn btn-primary"}}),console.error("Error deleting ticket:",t)}})})):"cancel"===e.dismiss&&Swal.fire({text:a+" was not deleted.",icon:"error",buttonsStyling:!1,confirmButtonText:"Ok, got it!",customClass:{confirmButton:"btn fw-bold btn-primary"}})}))}))}))},h=function(t){f=FormValidation.formValidation(o,{fields:{subject_wo:{validators:{notEmpty:{message:"Subject is required"}}},due_date:{validators:{notEmpty:{message:"Due Date is required"}}},description_wo:{validators:{notEmpty:{message:"Description is required"}}},staffSelect:{validators:{notEmpty:{message:"Please Assign A Staff"}}},priority:{validators:{notEmpty:{message:"Priority is required"}}}},plugins:{trigger:new FormValidation.plugins.Trigger({event:{password:!1}}),bootstrap:new FormValidation.plugins.Bootstrap5({rowSelector:".fv-row",eleInvalidClass:"",eleValidClass:""})}}),d.addEventListener("click",(function(t){t.preventDefault(),f.validate().then((function(t){"Valid"==t?($.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}),d.setAttribute("data-kt-indicator","on"),d.disabled=!0,$.ajax({url:"/apps/helpdesk/api/workorder",type:"POST",data:{ticket_id:$("#ticket_id").val(),subject:$("#subject_wo").val(),description:$("#description_wo").val(),due_date:$("#due_date").val(),staff:$("#staffSelect").val(),priority:$("#priority").val()},success:function(t){d.removeAttribute("data-kt-indicator"),d.disabled=!1,$("#kt_modal_new_work_order_form")[0].reset(),$("#kt_modal_work_order").modal("hide"),swal.fire({text:t.message,icon:"success",buttonsStyling:!1,confirmButtonText:"Ok, got it!",customClass:{confirmButton:"btn font-weight-bold btn-light-primary"}}).then((function(){d.removeAttribute("data-kt-indicator"),d.disabled=!1,$("#ticketTable").DataTable().ajax.reload()}))},error:function(t){d.removeAttribute("data-kt-indicator"),d.disabled=!1,Swal.fire({text:"Sorry, looks like there are some errors detected, please try again.",icon:"error",buttonsStyling:!1,confirmButtonText:"Ok, got it!",customClass:{confirmButton:"btn btn-primary"}})}})):Swal.fire({text:"Sorry, looks like there are some errors detected, please try again.",icon:"error",buttonsStyling:!1,confirmButtonText:"Ok, got it!",customClass:{confirmButton:"btn btn-primary"}})}))})),$("#ticketTable").on("click",".generate-work-order",(function(){var t=$(this).data("id");console.log("Generate work order for ID: "+t);var e=$(this).data("id");S(),$("#ticket_id").val(e)}));var e={selector:"#description_wo",height:"480"};"dark"===KTThemeMode.getMode()&&(e.skin="oxide-dark",e.content_css="dark"),tinymce.init(e)},y=function(t){k=FormValidation.formValidation(i,{fields:{notes:{validators:{notEmpty:{message:"Note is required"}}},"category[]":{validators:{choice:{min:1,max:5,message:"Please check minimum 1 category"}}}},plugins:{trigger:new FormValidation.plugins.Trigger({event:{password:!1}}),bootstrap:new FormValidation.plugins.Bootstrap5({rowSelector:".fv-row",eleInvalidClass:"",eleValidClass:""})}}),l.addEventListener("click",(function(t){t.preventDefault(),k.validate().then((function(t){if("Valid"==t){$(this).closest("tr").data("id");var e=[];$("input[name='category[]']:checked").each((function(){e.push($(this).val())})),$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}),l.setAttribute("data-kt-indicator","on"),l.disabled=!0,$.ajax({url:"/apps/helpdesk/api/workorder/notes",type:"POST",data:{ticket_id:$("#ticket_id").val(),notes:$("#notes").val(),category:e},success:function(t){l.removeAttribute("data-kt-indicator"),l.disabled=!1,$("#kt_modal_work_order_note").modal("hide"),swal.fire({text:t.message,icon:"success",buttonsStyling:!1,confirmButtonText:"Ok, got it!",customClass:{confirmButton:"btn font-weight-bold btn-light-primary"}}).then((function(){l.removeAttribute("data-kt-indicator"),l.disabled=!1,i.reset(),$("#ticketTable").DataTable().ajax.reload()}))},error:function(t){l.removeAttribute("data-kt-indicator"),l.disabled=!1,Swal.fire({text:"Sorry, looks like there are some errors detected, please try again.",icon:"error",buttonsStyling:!1,confirmButtonText:"Ok, got it!",customClass:{confirmButton:"btn btn-primary"}})}})}else Swal.fire({text:"Sorry, looks like there are some errors detected, please try again.",icon:"error",buttonsStyling:!1,confirmButtonText:"Ok, got it!",customClass:{confirmButton:"btn btn-primary"}})}))})),$("#ticketTable").on("click",".generate-notes",(function(){var t=$(this).data("id");console.log("Generate Notes for ID: "+t);var e=$(this).data("id");$("#ticket_id").val(e)}))},w=function(t){g=FormValidation.formValidation(n,{fields:{status:{validators:{notEmpty:{message:"Status is required"}}},reason:{validators:{notEmpty:{message:"Reason is required"}}}},plugins:{trigger:new FormValidation.plugins.Trigger({event:{password:!1}}),bootstrap:new FormValidation.plugins.Bootstrap5({rowSelector:".fv-row",eleInvalidClass:"",eleValidClass:""})}}),u.addEventListener("click",(function(t){t.preventDefault(),g.validate().then((function(t){if("Valid"==t){$(this).closest("tr").data("id");$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}),u.setAttribute("data-kt-indicator","on"),u.disabled=!0,$.ajax({url:"/apps/helpdesk/api/ticket/status",type:"POST",data:{ticket_id:$("#ticket_id").val(),status:$("#status").val(),reason:$("#reason").val()},success:function(t){u.removeAttribute("data-kt-indicator"),u.disabled=!1,$("#kt_modal_change_status").modal("hide"),swal.fire({text:t.message,icon:"success",buttonsStyling:!1,confirmButtonText:"Ok, got it!",customClass:{confirmButton:"btn font-weight-bold btn-light-primary"}}).then((function(){u.removeAttribute("data-kt-indicator"),u.disabled=!1,n.reset(),$("#ticketTable").DataTable().ajax.reload()}))},error:function(t){u.removeAttribute("data-kt-indicator"),u.disabled=!1,Swal.fire({text:"Sorry, looks like there are some errors detected, please try again.",icon:"error",buttonsStyling:!1,confirmButtonText:"Ok, got it!",customClass:{confirmButton:"btn btn-primary"}})}})}else Swal.fire({text:"Sorry, looks like there are some errors detected, please try again.",icon:"error",buttonsStyling:!1,confirmButtonText:"Ok, got it!",customClass:{confirmButton:"btn btn-primary"}})}))})),$("#ticketTable").on("click",".status-change",(function(){var t=$(this).data("id"),e=$(this).data("status");$("#ticket_id").val(t),$("#old_status").val(e)}))},v=function(a){p=FormValidation.formValidation(r,{fields:{subject:{validators:{notEmpty:{message:"Subject is required"}}},report_time:{validators:{notEmpty:{message:"Report Time is required"}}},sourcesReport:{validators:{notEmpty:{message:"Sources of Report is required"}}},"unit-dropdown":{validators:{notEmpty:{message:"Unit is required"}}},"issuecategory[]":{validators:{choice:{min:1,max:5,message:"Please check minimum 1 category"}}}},plugins:{trigger:new FormValidation.plugins.Trigger({event:{password:!1}}),bootstrap:new FormValidation.plugins.Bootstrap5({rowSelector:".fv-row",eleInvalidClass:"",eleValidClass:""})}}),c.addEventListener("click",(function(e){e.preventDefault(),r.reset(),$("#kt_docs_card_ticket_new").collapse("hide"),$("#kt_docs_card_ticket_list").collapse("show"),t.ajax.reload()})),s.addEventListener("click",(function(e){e.preventDefault(),p.validate().then((function(e){if("Valid"==e){$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}),s.setAttribute("data-kt-indicator","on"),s.disabled=!0;var a=[];$("input[name='issuecategory[]']:checked").each((function(){a.push($(this).val())})),$.ajax({url:"/apps/helpdesk/api/ticket",type:"POST",data:{subject:$("#subject").val(),description:$("#description").val(),report_time:$("#report_time").val(),reporter_name:$("#reporter-dropdown").val(),origin_unit:$("#unit-dropdown").val(),issue_category:a,source_report:$("#sourcesReport").val()},success:function(e){s.removeAttribute("data-kt-indicator"),s.disabled=!1,swal.fire({text:e.message,icon:"success",buttonsStyling:!1,confirmButtonText:"Ok, got it!",customClass:{confirmButton:"btn font-weight-bold btn-light-primary"}}).then((function(){s.removeAttribute("data-kt-indicator"),s.disabled=!1,$("#kt_docs_card_ticket_list").collapse("show"),$("#kt_docs_card_ticket_new").collapse("hide"),t.ajax.reload(),r.reset()}))},error:function(t){s.removeAttribute("data-kt-indicator"),s.disabled=!1,Swal.fire({text:"Sorry, looks like there are some errors detected, please try again.",icon:"error",buttonsStyling:!1,confirmButtonText:"Ok, got it!",customClass:{confirmButton:"btn btn-primary"}})}})}else Swal.fire({text:"Sorry, looks like there are some errors detected, please try again.",icon:"error",buttonsStyling:!1,confirmButtonText:"Ok, got it!",customClass:{confirmButton:"btn btn-primary"}})}))})),m.addEventListener("click",(function(t){t.preventDefault(),e.destroy()}))},S=function(t){fetch("/apps/helpdesk/api/workorder/staff").then((t=>{if(!t.ok)throw new Error(`HTTP error! Status: ${t.status}`);return t.json()})).then((t=>{const e=$("#staffSelect");e.empty(),t.forEach((t=>{const a=new Option(t,t);e.append(a)})),e.trigger("change")})).catch((t=>{console.error("Fetch error:",t.message)}))},T=function(t){try{return new URL(t),!0}catch(t){return!1}};return $("#report_time").flatpickr({enableTime:!0,dateFormat:"Y-m-d H:i",maxDate:new Date}),$("#due_date").flatpickr({enableTime:!0,dateFormat:"Y-m-d H:i",maxDate:new Date}),$("#staffSelect").select2({tags:!0,tokenSeparators:[","," "],createTag:function(t){return{id:t.term,text:t.term,newTag:!0}}}),{init:function(){b(),_(),S(),r=document.querySelector("#kt_new_ticket_form"),s=document.querySelector("#kt_new_ticket_submit"),c=document.querySelector("#kt_new_ticket_cancel"),o=document.querySelector("#kt_modal_new_work_order_form"),d=document.querySelector("#kt_modal_new_work_order_submit"),i=document.querySelector("#kt_modal_work_order_note_form"),l=document.querySelector("#kt_modal_work_order_note_submit"),n=document.querySelector("#kt_modal_change_status_form"),u=document.querySelector("#kt_modal_change_status_submit"),document.querySelector("#kt_modal_change_status_form"),m=document.querySelector("#kt_modal_history_status_close"),isSupervisor&&(T(s.closest("form").getAttribute("action")),v()),T(d.closest("form").getAttribute("action")),h(),T(l.closest("form").getAttribute("action")),y(),T(u.closest("form").getAttribute("action")),w()}}}();KTUtil.onDOMContentLoaded((function(){KTTicket.init()}));